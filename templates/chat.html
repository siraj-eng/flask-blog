{% extends "base.html" %}

{% block title %}Chat - Softnet Internal{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-orange text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Organization Chat</h4>
                </div>
                <div class="row g-0">
                    <div class="col-md-3 border-end bg-light" style="min-height:400px;">
                        <div class="p-2">
                            <h6 class="text-green">Online Users</h6>
                            <ul id="user-list" class="list-unstyled small mb-0"></ul>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="card-body" style="height: 400px; overflow-y: auto;" id="chat-messages">
                            <!-- Messages will appear here -->
                        </div>
                        <div class="card-footer bg-white">
                            <form id="chat-form" autocomplete="off">
                                <div class="input-group">
                                    <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." required>
                                    <button type="submit" class="btn btn-green">Send</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<audio id="chat-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae1b2.mp3" preload="auto"></audio>
<script>
    const socket = io();
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const username = "{{ session.get('full_name', session.get('username')) }}";
    const chatSound = document.getElementById('chat-sound');
    let windowFocused = true;
    const userList = document.getElementById('user-list');

    window.onfocus = () => { windowFocused = true; };
    window.onblur = () => { windowFocused = false; };

    // Request notification permission
    if (window.Notification && Notification.permission !== 'granted') {
        Notification.requestPermission();
    }

    function showNotification(title, body) {
        if (window.Notification && Notification.permission === 'granted') {
            new Notification(title, { body });
        }
    }

    socket.on('receive_message', function(data) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('mb-2');
        const time = data.created_at ? `<span class='text-muted small ms-2'>${data.created_at.slice(11,16)}</span>` : '';
        msgDiv.innerHTML = `<strong class=\"text-green\">${data.username}:</strong> <span>${data.message}</span> ${time}`;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (!windowFocused) {
            chatSound.play();
            showNotification('New Chat Message', `${data.username}: ${data.message}`);
        }
    });

    socket.on('user_list', function(users) {
        userList.innerHTML = '';
        users.forEach(function(user) {
            const li = document.createElement('li');
            li.textContent = user;
            li.classList.add('mb-1');
            userList.appendChild(li);
        });
    });

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
            socket.emit('send_message', {username, message});
            chatInput.value = '';
        }
    });
</script>
{% endblock %} 